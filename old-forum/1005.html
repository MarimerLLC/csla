<html><header><title>OT: Scrubbing Input Strings</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT: Scrubbing Input Strings</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1005.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil posted on Thursday, August 24, 2006</h2><P>I've written a tiny string scrubber for my ASP.NET application.&nbsp; I thought I'd post it here just to get input on it - a community built scrubber would probably give us all a better answer to work with so I'll throw this one out there as a place to start.</P>
<P>I imagine there are more efficient ways to do this - I went with the 'long hand' approach so that it would be clear what was going on and why.</P>
<P>&nbsp;</P><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> ScrubString(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> str </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">'Purpose : To scrub strings of characters that might be used</FONT></P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">' : in SQL injection attacks.</FONT></P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">'Trim spaces</FONT></P></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Trim</FONT></P>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">'Scrub potentially dangerous commands</FONT></P></FONT><FONT size=2>
<P><FONT face="Courier New">str = Regex.Replace(str, </FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"OPENROWSET"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT></FONT><FONT size=2><FONT face="Courier New">, RegexOptions.IgnoreCase)</FONT></P>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">'Kills the first part of some powerful SQL commands such as xp_cmdshell</FONT></P></FONT><FONT size=2>
<P><FONT face="Courier New">str = Regex.Replace(str, </FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"xp_"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT></FONT><FONT size=2><FONT face="Courier New">, RegexOptions.IgnoreCase)</FONT></P>
<P></FONT><FONT color=#008000 size=2><FONT face="Courier New">'Scrub potentially dangerous non-alphanumeric characters</FONT></P></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"-"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' - :used to comment out portions of a SQL query.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"*"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' * :used in hacked SQL to fish for information.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"&amp;"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"and"</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' &amp; :used to create special characters on web pages.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"="</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"equals"</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' = :used in hacked SQL to fish for information.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"&gt;"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>")"</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' &gt; :used to create unwanted HTML elements.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"&lt;"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"("</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' &lt; :used to create unwanted HTML elements.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"%"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' % :used in like statements to fish for data.</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"'"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' ' :used in string manipulation of SQL statements</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"/"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' / :used in SQL injection attacks</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>"\"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' / :used in SQL injection attacks</P></FONT></FONT><FONT size=2>
<P><FONT face="Courier New">str = str.Replace(</FONT></FONT><FONT face="Courier New"><FONT color=#800000 size=2>";"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2>) </FONT><FONT color=#008000 size=2>' / :used in SQL injection attacks</P></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New" color=#0000ff size=2>Return</FONT><FONT size=2><FONT face="Courier New"> str</FONT></P>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Thursday, August 24, 2006</h2><P>While I appreciate your effort and intentions, you will find that there are many, many times that some of the characters you have being filtered are legitimate characters in a data entry field.&nbsp; This is a pretty generic and pessimistic approach.</P>
<P>With web-apps, the best solution is to provide validation for all data entry fields.&nbsp; At that point, you can apply a regular expression filter (for instance) to identify unwanted characters.&nbsp; You can certainly create a helper class, such as StringScrubber, that exposes methods to handle the different scenerios you run across and assists with the validation so that the process is shared by all of your objects - which is what I think your intention is.</P>
<P>An example what I mean is to provide a validation check to determine if the entered value is actually an e-mail address, a date, numeric, social security number, url, etc.&nbsp; By restricting the field during validation, you can accomplish the same thing in an even MORE restrictive way than you have shown.&nbsp; Afterall, if it is a valid e-mail address, then it doesn't have most of what you are filtering already.</P>
<P>Not sure if that's the kind of feedback you were looking for.&nbsp; Just my 2 cents.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, August 24, 2006</h2>Wouldn't an easier way to guard against sql injection attacks be using Parameters exclusively?&nbsp; You can always use them, regardless of the database.<br><br>If you did want to go this route, why not just properly escape the string?<br><br><font face="Courier New"><font color="#0000ff">public static string</font> Scrub( <font color="#0000ff">string</font> input ) {<br>&nbsp;&nbsp; <font color="#0000ff">return string</font>.Format( <font color="#ff0000">"</font>'{0}'<font color="#ff0000">"</font>, input.Replace( <font color="#ff0000">"</font>'<font color="#ff0000">"</font>, <font color="#ff0000">"</font>''<font color="#ff0000">"</font> );<br>}</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, August 24, 2006</h2>You may have trouble with that.<br><br>What happens if you....<br>... run that filter when the user inputs an address like "123 O'Malley St.; Somewhere" ?<br>... enter the name of a company like "XYZ &amp; ZYX" ?<br>... Have a "note" field where the user might want to enter information like "(*) The value / price should be in the range 10-20"<br><br>And I could go on and on...<br><br>None of those special characters should be a problem if you stay away from dynamic sql.<br><br>And by dinamic sql I mean:<br>- A sproc that concatenates strings or values passes as params and runs them through exec(@somenastycommand).<br>- cmd.CommandText = "select * from table where id = " &amp; strMyID<br><br>These are the most common cases for problems.<br><br>So, do not dinamically generate sql code in your sps.<br>Do not concatenate in vb/c# that way.<br><br>If the user enters something like " 0 or 1=1 --" in the id field, and you run it by passing it as parameter, there will be no problems for you.<br><br>cmd.CommandText = "select * from table where id = @myID"<br>cmd.Parameters.AddWithValue("@myID", strMyID)<br><br><br>Whatch out with those filters, they could end up being a headache, and the origin of long hours of debugging to find out "why isn't the data being stored correctly?"<br><br>My 2 cents.<br><br>Andr√©s</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Thursday, August 24, 2006</h2>Thank you, Andres.&nbsp; You finished my thought better than I.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Thursday, August 24, 2006</h2><P>I used stored procedures for everything, However, I'd heard at one point that parameterized procedures weren't entirely safe.&nbsp; I'm not finding information on that right now besides the following:</P>
<P><FONT face=Tahoma>While stored procedures seem to be a wonderful panacea against injection attacks, this is not necessarily the case. As mentioned above, it is important to validate data to check that it is correct and it is a definite benefit of stored procedures that they can do this; however, it is doubly important to validate data if the stored procedure is going to use <CODE>EXEC(<I>some_string</I>)</CODE> where <CODE>some_string</CODE> is built up from data and string literals to form a new command.&nbsp; Source: <A href="http://www.codeproject.com/cs/database/SqlInjectionAttacks.asp">http://www.codeproject.com/cs/database/SqlInjectionAttacks.asp</A></FONT></P>
<P>So it may very well be that my string scrubbing is unnecessary if I stick with the stored procedures since I wouldn't EXEC on a string in a stored procedure anyways.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, August 24, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>MadGerbil:</strong></div><div>I used stored procedures for everything, However, I'd heard at one point that parameterized procedures weren't entirely safe.</div></BLOCKQUOTE><br><br>No, its not stored procedures which are the solution for all Sql injection attacks.&nbsp; Its using the SqlParameter objects and building your statements to leave in the appropriate place holders for the parameters which is the complete solution.&nbsp; <br><br>So you'd always do something like this:<br><br><font color="#7fffd4"><font color="#0000ff">SqlCommand</font> </font>cmd;<br><font color="#0000ff">SqlParameter</font> param;<br><br>cmd = <font color="#0000ff">new</font> <font color="#0000ff">SqlCommand</font>();<br>cmd.CommandText = <font color="#ff0000">"</font>select * from person where lastName = @LastName<font color="#ff0000">"</font>;<br>param = cmd.CreateParameter( <font color="#ff0000">"</font>@LastName<font color="#ff0000">"</font> );<br>param.Value = <font color="#ff0000">"</font>my unsafe string ' drop database master go;<font color="#ff0000">"<font color="#000000">;</font></font><br>cmd.Parameters.Add( param );<br><br>cmd.ExecuteReader();<br><br>The above code is 100% safe; your master database won't be dropped.&nbsp; The string will be stored exactly as is.&nbsp; Oh, well not 100% if you exec on the database... but I think injection attacks are a reason not to use the exec method on the database.&nbsp; If you need to build your sql, just do it in the code.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Thursday, August 24, 2006</h2><P>Thank you for the information.&nbsp; If I understand you correctly it is when a parameter is used to build a string instead of being used as place holder in a complete statement that a problem arises.&nbsp; That is, use a parameter as a parameter and not as a variable for string concatenation.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, August 24, 2006</h2>Right, I think (if I understand what you're saying).<br><br>Directly inserting the values (without using objects which implement IDataParameter) is the cause of the problem.<br><br>So this is a never-do:<br><br>string lastName&nbsp; = "my last ' drop database master go";<br>string sql = "select * from person where lastname = " + lastName;<br><br>Building your strings like that is what leads to the injection attacks.&nbsp; Ado.Net provides Parameters which allow you to define placeholders within the sql, and you use the objects which implement IDataParameter to 'fill in' the value.&nbsp; That will safe guard against the attacks.<br><br>HTH<br>Andy<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
