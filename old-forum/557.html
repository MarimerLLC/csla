<html><header><title>is it possible to change the DataPortalURL in code?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>is it possible to change the DataPortalURL in code?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/557.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sune42 posted on Thursday, July 06, 2006</h2><P>hi</P>
<P>is it possible to change the DataPortalURL in code?</P>
<P>As I want to the option to change the Server in my application loginform.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ruckus77 replied on Thursday, July 06, 2006</h2>Blib blah, boo ha. In the out to the dog, mouse is I.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 07, 2006</h2><P>No, it is not possible to change the URL in code using the existing data portal channels.</P>
<P>However, the data portal is specifically designed to be extensible - and that means you have the ability to write your own channel that could (for instance) allow dynamic changes to the server URL.</P>
<P>Each of the four existing channels are discussed in Chapter 4, and you could use any of them as a base for building your own channel. You can also look at the prototype WcfChannel (<A href="http://www.lhotka.net/Articles.aspx?id=0eec56bb-2a61-47c4-a9ca-f98371db1cad">http://www.lhotka.net/Articles.aspx?id=0eec56bb-2a61-47c4-a9ca-f98371db1cad</A>) to see how an external channel assembly is created.</P>
<P>I think there are all sorts of interesting possibilities here. Not only could you create a channel that allowed dynamic URL changes, but you could create a channel that had different rules for local vs remote calls, which is another very common request (online/offline mode switching).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, July 14, 2006</h2><P>Hi sune42</P>
<P>Have you got anywhere with this?&nbsp; Our application needs the option of running against multiple dataportal servers, as we have different "Environments" available to a user e.g. Live, Training, Test.&nbsp; Each environment has its own Server and Database, and&nbsp;the user needs to be able to select the environment on startup.&nbsp; Has anyone else done anything like this?</P>
<P>TIA.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>odie replied on Friday, July 14, 2006</h2><P>I have not had to deal with changing the Server but do have to give the user the ablity to select different databases. Here is what I wrote on another post a while back:</P>
<P>We have a similar situation where we have 3 Regions each with their own seperate database due to distance between locations. Additionally we have a development copy of the database for our own testing.</P>
<P>It may not be eligant but it works.</P>
<P>I have the following in my app.config file because until I get the connection string I can't get to a server.<BR><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>ConfigRegionCount</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>3</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>ConfigRegion1</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Calgary</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>ConfigRegion2</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Edmonton</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>ConfigRegion3</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Regina</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;</FONT></P>
<P><FONT color=#0000ff><FONT color=#000000>On my login form the user selects the region they wish to log into. Additionally I have a check box option for development database, but I wont go into that here.</FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#000000>Then&nbsp;based on which region they select I know which encrypted connection string to get from the database which looks like this.</FONT></FONT></P><FONT color=#0000ff><FONT color=#0000ff>
<P>&lt;</FONT><FONT color=#800000>add</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>DB:Calgary</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>bbNSKIAS8yO7...=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> /&gt;<BR>&lt;</FONT><FONT color=#800000>add</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>DB:Edmonton</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>j2X70krzexwuHFjNX...=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> /&gt;<BR>&lt;</FONT><FONT color=#800000>add</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>DB:Regina</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>HFjNXLK5MeJ0GN3K..</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> /&gt;<BR>&lt;</FONT><FONT color=#800000>add</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>DB:Development</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff>Qs7FXSVjM2k/uETt3cn5qnC6g...</FONT><FONT color=#000000>"</FONT><FONT color=#0000ff> /&gt;</FONT></P><FONT color=#0000ff>
<P><FONT color=#000000>This allows for any number of connection strings, if you have to add another you only have to add tow lines to your app.config file. Based on the region selected it knows what connection string to use. If the user wants to switch database they simply logoff which brings up the logon screen again and they select a different database. I store the users last logged on region to start with as the user is likely logging into the same database all the time. I don't have to worry about users logging into the wrong database as this is cared for by the security model we have implemented.</FONT></P>
<P><FONT color=#000000>Additionally the connections string is encrypted multiple times embedding both the data database connection string as well as the security database connection string together. But that another story.</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, July 14, 2006</h2><P>Hi odie.</P>
<P>Thanks very much for the info.&nbsp; Perhaps I'd better clarify.&nbsp; When I said "Each environment has its own Server and Database" I meant that each environment has its own DataPortal Server that will always connect to the Database associated with that environment e.g. Test DataPortal Server will connect to database TestDB and Training DataPortal Serverwill always connect tp database TrainDB.&nbsp; So the ability to switch DataPortalURL is the critical part for me.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Friday, July 14, 2006</h2><P>I have a similar issue.&nbsp; I need to allow data portal changes on the fly based on which account&nbsp;a user is viewing.&nbsp; If some criteria of that record is true, then use one dp for access, otherwise use another.&nbsp; </P>
<P>I can see how a channel can be written for your own needs, but I am having trouble seeing how you could make it dynamic on the fly based on the data.&nbsp; Has anyone already done this or can give me a theoretical idea of how to do it?&nbsp; I'd be happy to share my results.</P>
<P>Thanks,</P>
<P>Mike</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, July 14, 2006</h2>Well, one thing you could do is have the classes that need a different dataportal from the default implement some interface like.<br><br>Public Interface IDataportalHelper<br>&nbsp;&nbsp;&nbsp; Function GetDataportalType() As String 'or whatever<br>&nbsp;&nbsp;&nbsp; Function GetDataportalPath() As String<br>End Interface<br><br><br>And then your dataportal channel could check to see if the class implements that and take the appropiate route based on the information returned by those functions. Since the functions are implemented inside the actual classes, you could return different dataportal paths / types based on the object's data.<br><br>You would also need to do something similar for criteria objects, because usually you get or delete data based on the criteria alone. You could just implement the same interface in the criteria.<br><br>I will at some point have to do something similar, but in my case, it's simpler. What I need is to use a simpledataportal most of the time and use a remoting (or other, which I haven't yet decided) dataportal for a few objects that need to run some things on the server like reading some files that are not accesible through network shares. So for this case I'm thinking of just setting a class level attribute that indicates the object needs to pass through the remote dataportal and that's it.<br><br>My $0.02<br><br>Andr√©s<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, July 14, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Wbmstrmjb:</strong></div><div>
<P>I can see how a channel can be written for your own needs</P>
<P>Mike</P>
<P></div></BLOCKQUOTE></P>
<P>Hi Mike.</P>
<P>I wish I could understand how to do this. I looked at the Csla code extensively today and couldn't figure out what part Rocky was suggesting I write a custom version of.&nbsp; Maybe you can clear that up for me?</P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Friday, July 14, 2006</h2><P>Xal really helped me out on this one, so I need to give him credit for this, but I'll try to go into more detail.</P>
<P>The DataPortal.Client folder contains the Proxies for different channels.&nbsp; I am taking the RemotingProxy and creating a DynamicRemotingProxy that will allow for switching between URLs based on data.&nbsp; Since it is only changing the URL, the Host will still be the RemotingPortal.</P>
<P>I'm changing the CslaDataPortalUrl in the config to be a list of servers that I will parse out.&nbsp; You could probably do this a few different ways, but a simple parse means that I don't have to change the access method in ApplucationContext.&nbsp; Inside the new DynamicRemotingProxy class, I have added a DynamicRemotingProxyLocation enumeration to specify the various choices and those are associated to the config file servers.&nbsp; Here is my code for the changed Portal() method (used to be a property):</P><FONT color=#0000ff size=2>
<P>private</FONT><FONT size=2> Server.</FONT><FONT color=#008080 size=2>IDataPortalServer</FONT><FONT size=2> Portal(</FONT><FONT color=#008080 size=2>DynamicRemotingProxyLocation</FONT><FONT size=2> location)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;string</FONT><FONT size=2> dataPortalURL;</P>
<P></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;// still need to parse out the servers</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;dataPortalURL = </FONT><FONT color=#008080 size=2>ApplicationContext</FONT><FONT size=2>.DataPortalUrl.ToString();</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;if</FONT><FONT size=2> (_portal == </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_portal = (Server.</FONT><FONT color=#008080 size=2>IDataPortalServer</FONT><FONT size=2>)</FONT><FONT color=#008080 size=2>Activator</FONT><FONT size=2>.GetObject(</FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>(Server.Hosts.</FONT><FONT color=#008080 size=2>RemotingPortal</FONT><FONT size=2>), dataPortalURL);</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;return</FONT><FONT size=2> _portal;</P>
<P>}</P>
<P>Now in the methods of the Proxy such as Create, Fetch, Update, I am changing it to look at the object's interfaces to see if it has a new interface that I call IDynamicRemotingHelper.&nbsp; If so, it will call that function on the object to get the location.&nbsp; Here is that code for the Update:</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> Server.</FONT><FONT color=#008080 size=2>DataPortalResult</FONT><FONT size=2> Update(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> obj, Server.</FONT><FONT color=#008080 size=2>DataPortalContext</FONT><FONT size=2> context)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>&nbsp;&nbsp;&nbsp;DynamicRemotingProxyLocation</FONT><FONT size=2> location;</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;if</FONT><FONT size=2> (obj </FONT><FONT color=#0000ff size=2>is</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>IDynamicRemotingHelper</FONT><FONT size=2>)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location = ((</FONT><FONT color=#008080 size=2>IDynamicRemotingHelper</FONT><FONT size=2>)obj).PortalLocation;</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;else</FONT></P>
<P><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// my default location</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location = </FONT><FONT color=#008080 size=2>DynamicRemotingProxyLocation</FONT><FONT size=2>.EUR;</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;return</FONT><FONT size=2> Portal.Update(obj, context);</P>
<P>}</P>
<P>I hope this helps.&nbsp; If you need more clarification on an issue, let me know.&nbsp; When I finish, I will post changes and/or issues that I came across.</P></FONT></FONT><FONT color=#800000 size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Monday, July 17, 2006</h2><P>Mike.</P>
<P>This is great!&nbsp; Exactly the sort of idea I was looking for.&nbsp; I seem to be missing part of the picture though.&nbsp; Could you show me an example of how the IDynamicRemotingHelper.PortalLocation method is implemented and also what the DynamicRemotingProxyLocation enum looks like.&nbsp; Also, how are you parsing out the appropriate Url and what does the relevant section in your config file look like.&nbsp; Sorry for all the questions &lt;g&gt;.</P>
<P>Thanks!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Monday, July 17, 2006</h2><P>No problem.&nbsp; I know sometimes I also can't figure out how certain things work.</P>
<P>First a little background on my environment.&nbsp; We have 4 offices (I'll call them E, M, BR, and P - abbreviated of course).&nbsp; Each office could potentially have a portal but for now we just want to add a second.&nbsp; Currently E has a portal and we're adding P as a second.</P>
<P>The IDyanmicRemotingHelper.PortalLocation would be up to you.&nbsp; For me I need to base it on data in the object, so if my object Foo implements it and I base it going to a particular location on whether Bar is "sober" or something else, I could implement Portal Location as</P>
<P>public DynamicRemotingProxyLocation PortalLocation()</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;if (this.Bar == "sober")</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return DynamicRemotingProxylocation.E;</P>
<P>&nbsp;&nbsp;&nbsp;else</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return DynamicRemotingProxyLocation.P;</P>
<P>}</P>
<P>As for the DynamicRemotingProxyLocation enum, it's just a enum with E, M, BR, and P.&nbsp; Nothing special.</P>
<P>The URL is up to you how you want to parse it.&nbsp; Like I said you could probably modify things further and make room for multiple keys in the config file, but I didn't want to change ApplicationContext.&nbsp; You could just change your key to something like "{E}http://www.locationofE.com:{M}http://www.locationofM.com:{BR}http://www.locationofBR.com:{P}http://www.locationofP.com" and then just parse it with regualr expressions or something similar based on the return of PortalLocation.</P>
<P>Hope this helps!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Monday, July 17, 2006</h2><P>Interesting.&nbsp; My experiments led my down the path of adding to ApplicationContext rather than modifying it.&nbsp; I have a added a new configuration section, DataPortalURLs to the app.config file.&nbsp; This is a set of&nbsp;name value pairs&nbsp;i.e. Environment Name and URL.&nbsp; ApplicationContext then has a new property DynamicDataPortalURLs that retrieves this config section and sets another new property DynamicDataPortalURL by retrieving the corresponding URL from the list that matches the environment the user has selected.&nbsp; </P>
<P>The beauty of the DynamicRemotingProxy I wrote based on your code is that the changes I have made will only make a difference if the application is specifically set to use the new proxy type.&nbsp; If it is to use the new type then I simply force the application&nbsp;to specify an environment before allowing any DataPortal calls.&nbsp; Once the user selects the environment from the list, the selected value is stored in a third new ApplicationContext property.</P>
<P>I now have been told there maybe a requirement for having different forms within an application access different dataportals - Sigh!&nbsp; On the face of it this doesn't seem impossible as I could just provide some method to reset the proxy object.&nbsp; However, I am a little concerned of the performance aspect here....&nbsp; Anyway that is another story.&nbsp; Many thanks for your help, I think I have an acceptable solution now!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DancesWithBamboo replied on Friday, July 14, 2006</h2>We had this exact same requirement, only with hosted controls in the browser.&nbsp; The control had to talk back to&nbsp; he web server environment it was hosted from.&nbsp; All we did was pass in the url we wanted from the server to the control.&nbsp; Then the value in the config file was updated with the new url passed in.&nbsp; It works well and was really easy.&nbsp; I don't understand Rocky's comment about not being able to change it on the fly...<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, July 16, 2006</h2>




<DIV align=left><SPAN class=093102419-16072006><FONT face=Arial color=#0000ff size=2>In the web this would work (sort of) because each time 
web.config is edited it restarts the web application on the server. This can 
cause a&nbsp;huge performance problem in larger web sites, since it causes a 
recompile of the site, along with destruction of the caching, 
etc...</FONT></SPAN></DIV>
<DIV align=left><SPAN class=093102419-16072006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=093102419-16072006><FONT face=Arial color=#0000ff size=2>In Windows this won't work because changing the app.config 
doesn't cause a Windows app to quit and restart (as that would be very 
disruptive to the user).</FONT></SPAN></DIV>
<DIV align=left><SPAN class=093102419-16072006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=093102419-16072006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV><BR>
<BLOCKQUOTE>
  <DIV class=OutlookMessageHeader align=left>
  <HR>
  <FONT face=Tahoma size=2><B>From:</B> DancesWithBamboo 
  [mailto:cslanet@lhotka.net] <BR><B>Sent:</B> Friday, July 14, 2006 1:23 
  PM<BR><B>To:</B> rocky@lhotka.net<BR><B>Subject:</B> Re: [CSLA .NET] is it 
  possible to change the DataPortalURL in code?<BR></FONT><BR></DIV>
  <DIV></DIV>We had this exact same requirement, only with hosted controls in 
  the browser.&nbsp; The control had to talk back to&nbsp; he web server 
  environment it was hosted from.&nbsp; All we did was pass in the url we wanted 
  from the server to the control.&nbsp; Then the value in the config file was 
  updated with the new url passed in.&nbsp; It works well and was really 
  easy.&nbsp; I don't understand Rocky's comment about not being able to change 
  it on the fly...<BR><BR><BR><BR><BR></BLOCKQUOTE></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
